# PromptHub 设计文档

> 版本: v0.1.0  
> 更新日期: 2024-11

## 1. 系统架构

### 1.1 整体架构
PromptHub 采用 **Electron + React** 架构，实现跨平台桌面应用。

```
┌─────────────────────────────────────────────────────────────┐
│                      Electron Shell                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────────────────────┐  │
│  │   Main Process  │  │       Renderer Process          │  │
│  │                 │  │                                 │  │
│  │  - 窗口管理     │  │  ┌─────────────────────────┐   │  │
│  │  - 系统菜单     │  │  │      React App          │   │  │
│  │  - 快捷键       │  │  │                         │   │  │
│  │  - IPC 通信     │  │  │  Components + Stores    │   │  │
│  │                 │  │  │                         │   │  │
│  └────────┬────────┘  │  └───────────┬─────────────┘   │  │
│           │           │              │                  │  │
│           │  IPC      │              │                  │  │
│           └───────────┼──────────────┘                  │  │
│                       │                                 │  │
│  ┌────────────────────┴────────────────────────────┐   │  │
│  │              IndexedDB (Browser)                 │   │  │
│  │                                                  │   │  │
│  │  prompts | versions | folders | settings        │   │  │
│  └──────────────────────────────────────────────────┘   │  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 进程架构

| 进程 | 职责 | 技术栈 |
|------|------|--------|
| Main Process | 窗口管理、系统集成、IPC | Node.js + Electron |
| Renderer Process | UI 渲染、业务逻辑 | React + TypeScript |
| Preload Script | 安全桥接 Main 和 Renderer | Node.js |

### 1.3 目录结构
```
src/
├── main/                 # Electron 主进程
│   ├── index.ts         # 主进程入口
│   ├── menu.ts          # 应用菜单
│   ├── shortcuts.ts     # 全局快捷键
│   ├── database/        # 数据库模块（预留）
│   └── ipc/             # IPC 处理器（预留）
│
├── preload/             # 预加载脚本
│   └── index.ts         # 暴露安全 API
│
├── renderer/            # React 渲染进程
│   ├── App.tsx          # 应用根组件
│   ├── main.tsx         # 渲染入口
│   ├── components/      # UI 组件
│   │   ├── layout/      # 布局组件
│   │   ├── prompt/      # Prompt 相关组件
│   │   ├── settings/    # 设置组件
│   │   └── ui/          # 通用 UI 组件
│   ├── stores/          # Zustand 状态管理
│   ├── services/        # 服务层（数据库等）
│   ├── i18n/            # 国际化
│   └── styles/          # 全局样式
│
└── shared/              # 共享代码
    ├── types/           # TypeScript 类型定义
    └── constants/       # 常量定义
```

---

## 2. 技术选型

### 2.1 核心技术栈

| 类别 | 技术 | 版本 | 选型理由 |
|------|------|------|----------|
| 桌面框架 | Electron | 33.x | 跨平台、成熟生态 |
| 前端框架 | React | 18.x | 组件化、生态丰富 |
| 类型系统 | TypeScript | 5.x | 类型安全、开发体验 |
| 状态管理 | Zustand | 5.x | 轻量、简洁、支持持久化 |
| 样式方案 | TailwindCSS | 3.x | 原子化、开发效率高 |
| 构建工具 | Vite | 6.x | 快速、现代化 |
| 数据存储 | IndexedDB | - | 浏览器原生、无需额外依赖 |
| 国际化 | i18next | 24.x | 功能完善、React 集成好 |

### 2.2 开发工具

| 工具 | 用途 |
|------|------|
| ESLint | 代码规范检查 |
| Prettier | 代码格式化 |
| Vitest | 单元测试 |
| electron-builder | 应用打包 |

---

## 3. 数据层设计

### 3.1 存储方案
当前版本使用 **IndexedDB** 作为存储方案，优点：
- 浏览器原生支持，无需额外依赖
- 支持大容量存储
- 支持索引和事务
- 开发调试方便

> **注意**: 原计划使用 better-sqlite3，但由于与 Electron 33 的兼容性问题，暂时切换到 IndexedDB。

### 3.2 数据库 Schema

```
PromptHubDB (IndexedDB)
├── prompts          # Prompt 存储
│   ├── id (主键)
│   ├── folderId (索引)
│   ├── isFavorite (索引)
│   └── updatedAt (索引)
│
├── versions         # 版本历史存储
│   ├── id (主键)
│   ├── promptId (索引)
│   └── createdAt (索引)
│
├── folders          # 文件夹存储
│   ├── id (主键)
│   └── parentId (索引)
│
└── settings         # 设置存储
    └── key (主键)
```

### 3.3 数据操作 API

```typescript
// Prompt 操作
getAllPrompts(): Promise<Prompt[]>
getPromptById(id: string): Promise<Prompt | undefined>
createPrompt(data: CreatePromptDTO): Promise<Prompt>
updatePrompt(id: string, data: UpdatePromptDTO): Promise<Prompt>
deletePrompt(id: string): Promise<void>

// 版本操作
getPromptVersions(promptId: string): Promise<PromptVersion[]>
createPromptVersion(promptId: string, data: VersionData): Promise<PromptVersion>

// 文件夹操作
getAllFolders(): Promise<Folder[]>
createFolder(data: CreateFolderDTO): Promise<Folder>
deleteFolder(id: string): Promise<void>

// 备份恢复
exportDatabase(): Promise<DatabaseBackup>
importDatabase(backup: DatabaseBackup): Promise<void>
clearDatabase(): Promise<void>
```

---

## 4. 状态管理设计

### 4.1 Store 架构

使用 Zustand 进行状态管理，按功能模块拆分：

```
stores/
├── prompt.store.ts    # Prompt 状态
├── folder.store.ts    # 文件夹状态
└── settings.store.ts  # 设置状态（持久化）
```

### 4.2 Prompt Store

```typescript
interface PromptState {
  // 状态
  prompts: Prompt[];
  selectedId: string | null;
  isLoading: boolean;
  searchQuery: string;

  // Actions
  fetchPrompts: () => Promise<void>;
  createPrompt: (data: CreatePromptDTO) => Promise<Prompt>;
  updatePrompt: (id: string, data: UpdatePromptDTO) => Promise<void>;
  deletePrompt: (id: string) => Promise<void>;
  selectPrompt: (id: string | null) => void;
  setSearchQuery: (query: string) => void;
  toggleFavorite: (id: string) => Promise<void>;
}
```

### 4.3 Settings Store

```typescript
interface SettingsState {
  // 显示设置
  themeMode: 'light' | 'dark' | 'system';
  themeColor: string;
  fontSize: string;
  
  // 常规设置
  autoSave: boolean;
  showLineNumbers: boolean;
  
  // 语言设置
  language: 'zh' | 'en';
  
  // Actions
  setThemeMode: (mode: ThemeMode) => void;
  setThemeColor: (colorId: string) => void;
  applyTheme: () => void;
  // ...
}
```

---

## 5. 组件设计

### 5.1 组件层次

```
App
├── Sidebar                    # 侧边栏
│   ├── FolderTree            # 文件夹树
│   └── TagList               # 标签列表
│
├── TopBar                     # 顶部栏
│   ├── SearchInput           # 搜索框
│   └── ActionButtons         # 操作按钮
│
└── MainContent               # 主内容区
    ├── PromptList            # Prompt 列表
    │   └── PromptCard        # Prompt 卡片
    │
    └── PromptEditor          # Prompt 编辑器
        ├── EditorHeader      # 编辑器头部
        ├── EditorContent     # 编辑内容区
        └── EditorFooter      # 编辑器底部
```

### 5.2 核心组件

#### Sidebar
- 显示文件夹树和标签列表
- 支持文件夹的创建、编辑、删除
- 支持拖拽排序（待实现）

#### PromptList
- 显示 Prompt 列表
- 支持搜索过滤
- 支持按文件夹/标签/收藏筛选

#### PromptEditor
- Prompt 内容编辑
- 支持 System Prompt 和 User Prompt
- 变量高亮显示
- 自动保存

### 5.3 模态框组件

| 组件 | 用途 |
|------|------|
| CreatePromptModal | 创建新 Prompt |
| EditPromptModal | 编辑 Prompt |
| VersionHistoryModal | 查看版本历史 |
| SettingsModal | 快捷设置 |

---

## 6. 样式设计

### 6.1 设计系统

采用 **iOS 风格** 设计语言：
- 圆角卡片
- 毛玻璃效果
- 柔和阴影
- 流畅动画

### 6.2 主题系统

```css
/* CSS 变量定义 */
:root {
  --theme-hue: 220;        /* 主题色相 */
  --theme-saturation: 70;  /* 主题饱和度 */
  --base-font-size: 16px;  /* 基础字号 */
}

/* 莫兰迪色系主题 */
--royal-blue: hsl(220, 70%, 50%)  /* 宝蓝 - 默认 */
--blue: hsl(210, 35%, 50%)        /* 雾蓝 */
--purple: hsl(260, 30%, 50%)      /* 烟紫 */
--green: hsl(150, 30%, 50%)       /* 豆绿 */
--orange: hsl(25, 40%, 50%)       /* 杏橘 */
--teal: hsl(175, 30%, 50%)        /* 青黛 */
```

### 6.3 响应式设计

| 断点 | 宽度 | 布局 |
|------|------|------|
| 最小 | 800px | 侧边栏收起 |
| 默认 | 1200px | 三栏布局 |
| 宽屏 | 1600px+ | 扩展内容区 |

---

## 7. 待完善功能

### 7.1 已知 TODO

| 位置 | 描述 | 优先级 |
|------|------|--------|
| `main/index.ts` | 数据库与 Electron 33 兼容性问题 | 高 |
| `stores/folder.store.ts` | updateFolder 数据库实现 | 中 |
| `stores/folder.store.ts` | reorderFolders 数据库实现 | 中 |
| `components/layout/Header.tsx` | createPrompt API 调用 | 低（已有替代实现） |

### 7.2 功能待实现

| 功能 | 描述 | 复杂度 |
|------|------|--------|
| 变量填充界面 | 可视化填充变量值 | 中 |
| 版本对比 | 对比不同版本差异 | 中 |
| 自动备份 | 定期自动备份数据 | 低 |
| 自定义快捷键 | 用户自定义快捷键 | 中 |
| 拖拽排序 | 文件夹和 Prompt 拖拽排序 | 中 |

### 7.3 优化项

| 项目 | 描述 |
|------|------|
| 性能优化 | 大量 Prompt 时的虚拟滚动 |
| 无障碍 | 完善键盘导航和屏幕阅读器支持 |
| 测试覆盖 | 增加单元测试和 E2E 测试 |
| 错误处理 | 完善错误边界和用户提示 |

---

## 8. 开发指南

### 8.1 环境要求
- Node.js 18+
- pnpm 8+

### 8.2 开发命令

```bash
# 安装依赖
pnpm install

# 开发模式（Web）
pnpm dev

# 开发模式（Electron）
pnpm electron:dev

# 构建
pnpm build

# 打包应用
pnpm electron:build
```

### 8.3 代码规范

- 使用 TypeScript 严格模式
- 组件使用函数式组件 + Hooks
- 状态管理使用 Zustand
- 样式使用 TailwindCSS
- 提交信息遵循 Conventional Commits

---

## 9. 部署与发布

### 9.1 构建配置

参见 `electron-builder.json`：
- Windows: NSIS 安装包
- macOS: DMG 镜像
- Linux: AppImage

### 9.2 发布流程

1. 更新版本号 (`package.json`)
2. 更新 CHANGELOG
3. 构建各平台安装包
4. 创建 GitHub Release
5. 上传安装包

---

## 附录

### A. 相关文档
- [需求文档](./需求文档.md)
- [README](../README.md)
- [贡献指南](../CONTRIBUTING.md)

### B. 技术参考
- [Electron 文档](https://www.electronjs.org/docs)
- [React 文档](https://react.dev/)
- [Zustand 文档](https://zustand-demo.pmnd.rs/)
- [TailwindCSS 文档](https://tailwindcss.com/docs)
